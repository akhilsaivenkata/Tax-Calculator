
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>server: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/akhilsaivenkata/go-tax-calculator/cmd/server/main.go (0.0%)</option>
				
				<option value="file1">github.com/akhilsaivenkata/go-tax-calculator/internal/client/client.go (100.0%)</option>
				
				<option value="file2">github.com/akhilsaivenkata/go-tax-calculator/internal/handler/handler.go (100.0%)</option>
				
				<option value="file3">github.com/akhilsaivenkata/go-tax-calculator/internal/service/service.go (100.0%)</option>
				
				<option value="file4">github.com/akhilsaivenkata/go-tax-calculator/pkg/logger/logger.go (100.0%)</option>
				
				<option value="file5">github.com/akhilsaivenkata/go-tax-calculator/pkg/middleware/request_logger.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

import (
        "log"
        "os"

        "github.com/akhilsaivenkata/go-tax-calculator/internal/client"
        "github.com/akhilsaivenkata/go-tax-calculator/internal/handler"
        "github.com/akhilsaivenkata/go-tax-calculator/internal/service"
        "github.com/akhilsaivenkata/go-tax-calculator/pkg/logger"
        "github.com/akhilsaivenkata/go-tax-calculator/pkg/middleware"
        "github.com/gin-gonic/gin"
)

func main() <span class="cov0" title="0">{

        logger.Init()

        r := gin.New()
        r.Use(gin.Recovery())             // To recover from panics
        r.Use(middleware.RequestLogger()) // This is for the custom structured logger

        // Init dependencies
        apiBaseURL := os.Getenv("TAX_API_URL")
        if apiBaseURL == "" </span><span class="cov0" title="0">{
                log.Fatal("TAX_API_URL is not set")
        }</span>

        <span class="cov0" title="0">apiClient := client.NewTaxAPIClient(apiBaseURL)
        //apiClient := client.NewTaxAPIClient("http://localhost:5001") [Uncomment this line if you want to run it locally without env variables]
        taxService := service.NewTaxService()
        taxHandler := handler.NewTaxHandler(apiClient, taxService)

        taxHandler.RegisterRoutes(r)

        logger.Log.Info("Server starting on :8080")
        r.Run(":8080")</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package client

import (
        "encoding/json"
        "fmt"
        "io"
        "net/http"
        "time"

        "github.com/akhilsaivenkata/go-tax-calculator/internal/model"
        "github.com/akhilsaivenkata/go-tax-calculator/pkg/logger"
)

// TaxClient defines an interface for fetching tax brackets
type TaxClient interface {
        GetTaxBrackets(year int) (*model.TaxAPIResponse, error)
}

// TaxAPIClient defines the client structure
type TaxAPIClient struct {
        BaseURL    string
        HTTPClient *http.Client
}

// NewTaxAPIClient creates a new instance with sensible defaults
func NewTaxAPIClient(baseURL string) *TaxAPIClient <span class="cov8" title="1">{
        return &amp;TaxAPIClient{
                BaseURL: baseURL,
                HTTPClient: &amp;http.Client{
                        Timeout: 7 * time.Second,
                },
        }
}</span>

// GetTaxBrackets fetches the brackets for a given year from the Flask API
func (c *TaxAPIClient) GetTaxBrackets(year int) (*model.TaxAPIResponse, error) <span class="cov8" title="1">{
        url := fmt.Sprintf("%s/tax-calculator/tax-year/%d", c.BaseURL, year)

        logger.Log.WithFields(map[string]interface{}{
                "year": year,
                "url":  url,
        }).Info("Calling tax API to fetch brackets")

        resp, err := c.HTTPClient.Get(url)
        if err != nil </span><span class="cov8" title="1">{
                logger.Log.WithError(err).WithFields(map[string]interface{}{
                        "url": url,
                }).Error("Failed to reach tax API")
                return nil, fmt.Errorf("failed to reach tax API: %w", err)
        }</span>
        <span class="cov8" title="1">defer resp.Body.Close()

        if resp.StatusCode != http.StatusOK </span><span class="cov8" title="1">{
                body, _ := io.ReadAll(resp.Body)
                logger.Log.WithFields(map[string]interface{}{
                        "status": resp.StatusCode,
                        "body":   string(body),
                        "url":    url,
                }).Error("Received non-200 response from tax API")
                return nil, fmt.Errorf("API error [%d]: %s", resp.StatusCode, string(body))
        }</span>

        <span class="cov8" title="1">var taxResp model.TaxAPIResponse
        if err := json.NewDecoder(resp.Body).Decode(&amp;taxResp); err != nil </span><span class="cov8" title="1">{
                logger.Log.WithError(err).Error("Failed to decode tax API response")
                return nil, fmt.Errorf("failed to decode response: %w", err)
        }</span>

        <span class="cov8" title="1">logger.Log.WithField("brackets_count", len(taxResp.TaxBrackets)).Info("Successfully fetched tax brackets")
        return &amp;taxResp, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package handler

import (
        "net/http"

        "github.com/gin-gonic/gin"

        "github.com/akhilsaivenkata/go-tax-calculator/internal/client"
        "github.com/akhilsaivenkata/go-tax-calculator/internal/model"
        "github.com/akhilsaivenkata/go-tax-calculator/internal/service"
        "github.com/akhilsaivenkata/go-tax-calculator/pkg/logger"
)

type TaxHandler struct {
        Client  client.TaxClient
        Service *service.TaxService
}

func NewTaxHandler(c client.TaxClient, s *service.TaxService) *TaxHandler <span class="cov8" title="1">{
        return &amp;TaxHandler{
                Client:  c,
                Service: s,
        }
}</span>

// RegisterRoutes connects the routes to Gin
func (h *TaxHandler) RegisterRoutes(r *gin.Engine) <span class="cov8" title="1">{
        r.POST("/calculate-tax", h.CalculateTax)
}</span>

// CalculateTax is the main endpoint logic
func (h *TaxHandler) CalculateTax(c *gin.Context) <span class="cov8" title="1">{
        var req model.TaxCalculationRequest

        // Parsing request body
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov8" title="1">{
                logger.Log.WithError(err).Warn("Failed to parse request body")
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "Invalid request payload. Make sure 'income' (float) and 'tax_year' (int) are provided.",
                })
                return
        }</span>

        // Manual input validation
        <span class="cov8" title="1">if req.Income &lt;= 0 </span><span class="cov8" title="1">{
                logger.Log.WithField("income", req.Income).Warn("Income must be positive")
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "Income must be a positive number greater than 0.",
                })
                return
        }</span>

        <span class="cov8" title="1">if req.TaxYear &lt; 2019 || req.TaxYear &gt; 2022 </span><span class="cov8" title="1">{
                logger.Log.WithField("taxYear", req.TaxYear).Warn("Unsupported tax year")
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "Tax year must be one of: 2019, 2020, 2021, 2022.",
                })
                return
        }</span>

        <span class="cov8" title="1">logger.Log.WithFields(map[string]interface{}{
                "income":  req.Income,
                "taxYear": req.TaxYear,
        }).Info("Processing tax calculation request")

        // Fetching tax brackets from external API
        bracketsResp, err := h.Client.GetTaxBrackets(req.TaxYear)
        if err != nil </span><span class="cov8" title="1">{
                logger.Log.WithError(err).Error("Failed to fetch tax brackets from API")
                c.JSON(http.StatusBadGateway, gin.H{
                        "error": "Failed to fetch tax brackets from external service. Please try again.",
                })
                return
        }</span>

        // Calculating tax
        <span class="cov8" title="1">result := h.Service.CalculateTax(req.Income, bracketsResp.TaxBrackets)

        logger.Log.WithFields(map[string]interface{}{
                "total_tax":     result.TotalTax,
                "effective_tax": result.EffectiveTax,
        }).Info("Successfully calculated tax")

        // Returning result
        c.JSON(http.StatusOK, result)</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package service

import (
        "github.com/akhilsaivenkata/go-tax-calculator/internal/model"
        "github.com/akhilsaivenkata/go-tax-calculator/pkg/logger"
)

// TaxService handles the tax calculation
type TaxService struct{}

// NewTaxService returns a new instance
func NewTaxService() *TaxService <span class="cov8" title="1">{
        return &amp;TaxService{}
}</span>

// CalculateTax applies the marginal tax logic
func (s *TaxService) CalculateTax(income float64, brackets []model.TaxBracket) model.TaxCalculationResult <span class="cov8" title="1">{
        logger.Log.WithField("income", income).Info("Starting tax calculation")

        var totalTax float64
        var breakdown []model.TaxBandResult

        for _, bracket := range brackets </span><span class="cov8" title="1">{
                var upper float64
                if bracket.Max == 0 </span><span class="cov8" title="1">{
                        // No max means it's the highest bracket (infinite upper bound)
                        upper = income
                }</span> else<span class="cov8" title="1"> {
                        upper = bracket.Max
                }</span>

                // Taxable amount = income in this bracket
                <span class="cov8" title="1">if income &gt; bracket.Min </span><span class="cov8" title="1">{
                        taxable := min(income, upper) - bracket.Min
                        taxPaid := taxable * bracket.Rate

                        logger.Log.WithFields(map[string]interface{}{
                                "bracket_min": bracket.Min,
                                "bracket_max": bracket.Max,
                                "rate":        bracket.Rate,
                                "taxable":     taxable,
                                "tax_paid":    taxPaid,
                        }).Info("Calculated tax for bracket")

                        totalTax += taxPaid

                        breakdown = append(breakdown, model.TaxBandResult{
                                Min:     bracket.Min,
                                Max:     bracket.Max,
                                Rate:    bracket.Rate,
                                TaxPaid: taxPaid,
                        })
                }</span>
        }

        // Avoid division by zero
        <span class="cov8" title="1">var effectiveRate float64
        if income &gt; 0 </span><span class="cov8" title="1">{
                effectiveRate = totalTax / income
        }</span>

        <span class="cov8" title="1">logger.Log.WithFields(map[string]interface{}{
                "total_tax":      totalTax,
                "effective_rate": effectiveRate,
        }).Info("Finished tax calculation")

        return model.TaxCalculationResult{
                TotalTax:     totalTax,
                EffectiveTax: effectiveRate,
                Breakdown:    breakdown,
        }</span>
}

// min returns the smaller of two floats
func min(a, b float64) float64 <span class="cov8" title="1">{
        if a &lt; b </span><span class="cov8" title="1">{
                return a
        }</span>
        <span class="cov8" title="1">return b</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package logger

import (
        "os"

        "github.com/sirupsen/logrus"
)

var Log *logrus.Logger

func Init() <span class="cov8" title="1">{
        Log = logrus.New()
        Log.SetFormatter(&amp;logrus.JSONFormatter{}) // Structured JSON logs
        Log.SetOutput(os.Stdout)
        Log.SetLevel(logrus.InfoLevel)
}</span>
</pre>
		
		<pre class="file" id="file5" style="display: none">package middleware

import (
        "time"

        "github.com/gin-gonic/gin"
        "github.com/sirupsen/logrus"
)

func RequestLogger() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                start := time.Now()

                c.Next() // process request

                duration := time.Since(start)
                logrus.WithFields(logrus.Fields{
                        "method":   c.Request.Method,
                        "path":     c.Request.URL.Path,
                        "status":   c.Writer.Status(),
                        "duration": duration,
                }).Info("Request completed")
        }</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
